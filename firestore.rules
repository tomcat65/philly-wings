rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for authentication and authorization
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        (request.auth.token.admin == true || request.auth.token.admin == 'true');
    }

    function isOwner(userId) {
      return isAuthenticated() &&
        request.auth.uid == userId;
    }

    function isValidEmail(email) {
      return email.matches('[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}');
    }

    // Settings collection - read-only for all authenticated users, write for admins only
    match /settings/{document=**} {
      allow read: if true; // Public settings for app configuration
      allow write: if isAdmin();
    }

    // Menu items - public read, admin write (variant-based schema)
    match /menuItems/{itemId} {
      allow read: if true; // Public menu
      allow create, update: if isAdmin() &&
        // Required core fields
        request.resource.data.keys().hasAll(['name', 'category']) &&
        request.resource.data.name is string &&
        request.resource.data.category is string &&
        // Optional basePrice allowed on some docs
        (!('basePrice' in request.resource.data) ||
          (request.resource.data.basePrice is number && request.resource.data.basePrice >= 0)) &&
        // If variants present, ensure it's a list (deep validation kept light for flexibility)
        (!('variants' in request.resource.data) ||
          (request.resource.data.variants is list));
      allow delete: if isAdmin();
    }

    // Combos - public read, admin write (supports items[] or components[] and basePrice)
    match /combos/{comboId} {
      allow read: if true; // Public combos
      allow create, update: if isAdmin() &&
        request.resource.data.keys().hasAll(['name']) &&
        request.resource.data.name is string &&
        // Optional basePrice allowed
        (!('basePrice' in request.resource.data) ||
          (request.resource.data.basePrice is number && request.resource.data.basePrice >= 0)) &&
        // Must include either items[] or components[]
        (
          (('items' in request.resource.data) && request.resource.data.items is list) ||
          (('components' in request.resource.data) && request.resource.data.components is list)
        );
      allow delete: if isAdmin();
    }

    // Orders - authenticated users can create and read their own
    match /orders/{orderId} {
      allow read: if isAuthenticated() &&
        (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['items', 'total', 'status']) &&
        request.resource.data.status == 'pending';
      allow update: if isAuthenticated() &&
        (isOwner(resource.data.userId) &&
         request.resource.data.status in ['cancelled'] &&
         resource.data.status == 'pending') ||
        isAdmin();
      allow delete: if isAdmin();
    }

    // Live orders - public read for display, admin write
    match /liveOrders/{orderId} {
      allow read: if true; // Public display board
      allow write: if isAdmin();
    }

    // Reviews - authenticated users can create, public read
    match /reviews/{reviewId} {
      allow read: if true; // Public reviews
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['rating', 'comment']) &&
        request.resource.data.rating >= 1 &&
        request.resource.data.rating <= 5;
      allow update: if isOwner(resource.data.userId) &&
        request.resource.data.userId == resource.data.userId; // Can't change ownership
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // User profiles - users can read/write their own profile
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() &&
        request.auth.uid == userId &&
        request.resource.data.keys().hasAll(['email', 'createdAt']);
      allow update: if isOwner(userId) &&
        request.resource.data.email == resource.data.email; // Can't change email
      allow delete: if isAdmin();
    }

    // Admin users collection - restricted access
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Game day banners - public read, admin write
    match /gameDayBanners/{bannerId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Nutrition data - public read, admin write
    match /nutritionData/{itemId} {
      allow read: if true; // Public nutrition information
      allow write: if isAdmin();
    }

    // Modifier groups - public read, admin write
    match /modifierGroups/{groupId} {
      allow read: if true; // Public modifier options
      allow write: if isAdmin();
    }

    // Sauces - public read, admin write
    match /sauces/{sauceId} {
      allow read: if true; // Public sauce information
      allow write: if isAdmin();
    }

    // Plant-based wings - public read, admin write
    match /plantBasedWings/{itemId} {
      allow read: if true; // Public menu
      allow write: if isAdmin();
    }

    // Desserts - public read, admin write
    match /desserts/{itemId} {
      allow read: if true; // Public menu
      allow write: if isAdmin();
    }

    // Fresh salads - public read, admin write
    match /freshSalads/{itemId} {
      allow read: if true; // Public menu
      allow write: if isAdmin();
    }

    // Cold sides - public read, admin write
    match /coldSides/{itemId} {
      allow read: if true; // Public menu
      allow write: if isAdmin();
    }

    // Published menus - public read, admin write
    match /publishedMenus/{menuId} {
      allow read: if true; // Public menu snapshots
      allow write: if isAdmin();
    }

    // Email subscribers - enhanced for acquisition system
    match /emailSubscribers/{subscriberId} {
      allow read: if isAdmin();
      allow create: if true && // Anyone can subscribe
        request.resource.data.email is string &&
        isValidEmail(request.resource.data.email) &&
        request.resource.data.keys().hasAll(['email', 'subscribedAt']);
      allow update, delete: if isAdmin();
    }

    // Scheduled reminders - admin only
    match /scheduledReminders/{reminderId} {
      allow read, write: if isAdmin();
    }

    // Email queue - admin only
    match /emailQueue/{emailId} {
      allow read, write: if isAdmin();
    }

    // A/B test results - admin read, system write
    match /abTestResults/{testId} {
      allow read: if isAdmin();
      allow create: if true; // System can log test results
      allow update, delete: if isAdmin();
    }

    // Analytics events - system write, admin read
    match /analyticsEvents/{eventId} {
      allow read: if isAdmin();
      allow create: if true; // System can log events
      allow update, delete: if isAdmin();
    }

    // ============================================================================
    // CATERING COLLECTIONS - ezCater Integration
    // ============================================================================

    // Catering packages - public read, admin write
    match /cateringPackages/{packageId} {
      allow read: if true; // Public for frontend showcase
      allow write: if isAdmin(); // Only admins can modify packages
    }

    // Catering add-ons - public read, admin write
    match /cateringAddOns/{addOnId} {
      allow read: if true; // Public for tier-based add-on selection
      allow write: if isAdmin(); // Only admins can modify add-ons
    }

    // Catering orders - admin only (contains customer PII from ezCater)
    match /cateringOrders/{orderId} {
      allow read: if isAdmin(); // Contains sensitive customer data
      allow write: if false; // Only Firebase Functions via admin SDK can write
      // Orders created by ezCater webhook handler (server-side only)
    }

    // Catering availability - admin only (internal capacity tracking)
    match /cateringAvailability/{date} {
      allow read: if isAdmin(); // Internal capacity data
      allow write: if false; // Only Firebase Functions update availability
    }

    // ezCater sync logs - admin read only
    match /ezCaterSyncLog/{logId} {
      allow read: if isAdmin(); // For debugging sync issues
      allow write: if false; // Only Firebase Functions log syncs
    }

    // Notifications - admin only
    match /notifications/{notificationId} {
      allow read: if isAdmin(); // Admin dashboard notifications
      allow write: if false; // Only Firebase Functions create notifications
    }

    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

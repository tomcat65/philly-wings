# Session Log — 2025‑09‑20 (Philly Wings Express)

## Summary
- Synced menu data across Firestore, site JSON, seeds, and admin.
- Generated Storage manifest and audits; fixed missing assets; enabled WebP rollout.
- Corrected combo images/text (Tailgater, Game Day 30) everywhere.
- Hardened WebP client code; allowed nested Storage reads; prepared derivative sweep.
- Cleaned repo references; added icons and tiny story endpoint to public; fixed rules/indexes.
 - Preview audit (mobile) completed post‑deploy; favicon/manifest warnings resolved; site now serves WebP across sections (non‑WebP count 0, broken 0).

## Firestore
- menuItems: kept `wings`; added/updated base items:
  - `fries` (regular/large/loaded)
  - `mozzarella_sticks` (4/6/8/12/16)
  - `drinks` (water-bottle)
- combos:
  - `combo-game-day-30` description updated → now includes 2 large fries + 8 mozz sticks; items updated.
- nutritionData: verified 12/24/30/50 and dips; no changes needed.
- Rules: variant-based schema for `menuItems` and `combos` (removed legacy `price` requirement; allow `variants`/`basePrice`).
- Indexes: added composites for `reviews`, `gameDayBanners`, `liveOrders`, `combos`, `menuItems`.

## Storage
- Bucket: `philly-wings.firebasestorage.app`.
- Manifest: `docs/firebase/storage-manifest.md|json` (now 137 objects)
- Audits:
  - Link 404s: fixed (live content clean)
  - WebP coverage: initially 1 miss → resolved; homepage still has a few filenames without derivatives.
- Uploaded assets:
  - Dips: `images/blue-cheese.png`, `cheese-sauce.png`, `honey-mustard.png`, `ranch-dip.png`
  - Water bottle (sport cap): `images/water-bottle.png` and `.jpg`, derivatives present
- Storage rules: changed to allow nested paths `match /images/{allPaths=**}` to enable `/images/resized/*` reads.
 - Verified `images/resized/*_800x800.webp` (and 200x200/1920x1080 where applicable) exist for all sauces/combos referenced.

## Site & Admin
- public/data/combos.json:
  - Added Game Day 30; updated description/items; Tailgater image fixed
- index.html:
  - Game Day 30 card text updated; absolute `/scripts.js`, tiny story endpoint auto-loads
- Admin (admin/menu-master.js): Game Day 30 description/includes updated
- Seed scripts: `seed-test-data.js` and `seed-with-admin.js` combos updated
- PDF (menu-pdf.html): Game Day 30 text updated
- WebP client code: src/services/webp-image-service.js hardened to avoid recursion and ensure swap
- Combos fetch: cache bust + `no-store` to avoid stale JSON
 - Favicon/manifest: removed temporary redirect in `firebase.json`; manifest icons load direct (200 OK).
 - WebP direct links: replaced PNGs with WebP derivatives where static (index.html quick picks, gallery, sides, wing-type icons).
 - sauces.json: switched all sauce images to WebP derivatives.
 - combos.json: switched all combo images to WebP derivatives; confirmed live preview loads WebP URLs.
 - WebP client enhancement: added MutationObserver to auto‑swap dynamically injected images.

## Public assets
- Copied root icons into `public/`: android-chrome-192/512, apple-touch-icon, favicons
- Added tiny content endpoint at `public/api/content/our-story`
- Added `public/scripts.js` for `/scripts.js` path

## Hosting
 - firebase.json: removed temporary redirect for `/android-chrome-192x192.png`; icons served from root without redirect.
 - Canonical redirect: Resolved — acceptable to serve apex directly (no apex→www 301 enforced).

## GitHub / CI
- Pushed via admin PR; preview built via GH Action (npm ci → npm run build → deploy preview)
- Pending: add CI audit job (manifest, link 404, WebP) to PRs

## Open Items / Next Steps
1) Nutrition: verify/create `nutritionData` docs for 12/24/30/50 wings and sides/combos noted
2) Published menu flow: enforce immutable snapshots (`publishedMenus` allow create only), add export/backup utility
3) Admin access: ensure `customClaims.admin=true` for admin accounts
4) CI audits: add PR job for storage manifest, link 404s, WebP coverage

## References
- Preview URL: https://philly-wings--pr2-admin-ryoe43se.web.app/
- Branch: `admin` (latest commits include combos/webp/storage updates)
- Storage manifest/audits: `docs/firebase/*`
## Nutrition Combos – Implementation Snapshot (PR: nutrition, preview pr3)

- Admin compute path
  - Added combo editor fields: `servingsPerCombo`, `saucePolicy`, `representativeSauceId`, `saucePortionRule` (JSON), `disclaimer`.
  - On Save (combos) computes `computedNutrition` (perCombo, perServing, allergens union, breakdown, sauceNote, lastComputedAt) and writes to `combos/{id}`.
  - Recompute button in Platform Menu: iterates combos, recomputes, persists `computedNutrition`; uploads `public/combos-nutrition.json` (to be gated/CF later).

- Modal updates (site)
  - Prefers `combos/{id}.computedNutrition`.
  - Fallbacks: compute from Firestore combos `items[]` → lastly from static `/data/combos.json`.
  - Renders “What’s inside” breakdown, sauce note, disclaimer; per-combo/per-serving toggle supported for computed combos.

- Sauce nutrition
  - 6 per‑ounce sauce docs added to `nutritionData` (category `sauces`): `mild-buffalo-1oz`, `bbq-1oz`, `garlic-parm-1oz`, `honey-mustard-1oz`, `ranch-1oz`, `blue-cheese-1oz`.
  - Representative sauce logic adds per‑oz values per `saucePortionRule` (e.g., 1 oz per 6 wings).

- Firebase
  - Firestore rules updated: `isAdmin()` accepts boolean or string claim; deployed.
  - Preview recompute: Firestore now readable; Storage upload still 403 → not blocking once gated.

- Recommendation / Next
  - Short term: gate Storage upload with `VITE_ENABLE_NUTRITION_FEED_UPLOAD=false`; recompute succeeds on Firestore only.
  - Mid term: move feed generation to Cloud Function (on combos/nutritionData changes + callable for manual recompute).
  - UX: replace alert with toast; note when feed upload is skipped.

## Follow‑up — Nutrition Preview Updates (Later on 2025‑09‑20)

What we implemented
- Feature flag: added `VITE_ENABLE_NUTRITION_FEED_UPLOAD` gate in Admin Platform Menu.
- Gated upload: client skips uploading `public/combos-nutrition.json` when flag is false; still recomputes and writes `computedNutrition` to Firestore.
- UX: replaced alert with a green toast on recompute. Shows “Combo nutrition recomputed. Feed upload skipped.” when gated.
- Sanitizer: deep cleanup function strips undefined/NaN/Infinity prior to `updateDoc` to satisfy Firestore validation.
- Minor: only adds `sauceNote` when present; avoids undefined fields in `computedNutrition`.
- Logos: added platform logos under `public/images/logos/` (DoorDash, UberEats, Grubhub) to remove 404s in the Platform tabs.

Files modified
- `admin/platform-menu.js` — added env flag, sanitizer, toast, upload gating, and minor serialization fix.
- `GITHUB_ACTIONS_SETUP.md` — documented `VITE_ENABLE_NUTRITION_FEED_UPLOAD` secret.
- `public/images/logos/doordash-logo.svg` — added.
- `public/images/logos/ubereats-logo.svg` — added.
- `public/images/logos/grubhub-logo.svg` — added.

Branches / commits
- Nutrition branch: pushed changes (sanitizer, gating, toast, logos); added no‑op bump to force new asset hash.
- Admin branch: briefly cherry‑picked, then aligned with nutrition; final deploys target `nutrition`.

Preview verification
- Recompute button now: shows success toast and updates Firestore `computedNutrition` without client‑side Storage upload.
- Console: previous `Unsupported field value: undefined` updateDoc errors are gone (sanitizer active).
- Network: no Storage PUTs; Firestore writes only.
- UI: platform logos load (no 404s); price badges display icons.

Open items
- Cloud Functions: move recompute/publish server‑side (onWrite for `combos/*` and `nutritionData/*` + callable for manual admin run).
- CI: add audit job (Storage manifest, link 404s, WebP coverage) on PRs.
- Backups: export core collections (`menuItems`, `combos`, `sauces`, `modifierGroups`, `nutritionData`).
